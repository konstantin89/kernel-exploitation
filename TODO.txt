Write keyboard hood driver. Example can be found in Windows-driver-samples\input\kbfiltr.

Windbg - hal!KfLowerIrql - get implementation of kernel methods.

Page 275 - Get list of kernel modules and their address.

