#include <windows.h>
#include <winioctl.h>
#include <Sddl.h>
#include <tchar.h>
#include <stdio.h>
#include "KernelExploit.h"
#include "KernelArch.h"

SYSTEM_INFO GlobalInfo;


ULONG_PTR GetAnonymousMap(UINT blocks, BOOL exec, PVOID preferredAddress)
{
  HANDLE FileMapping=0;
  UINT_PTR LinearMapping=0;
  DWORD ProtMapping = PAGE_EXECUTE_READWRITE;
  DWORD ProtView    = FILE_MAP_EXECUTE | FILE_MAP_READ| FILE_MAP_WRITE;
  DWORD Size = GlobalInfo.dwAllocationGranularity*blocks;

  if(!exec)
  {
    ProtMapping = PAGE_READWRITE;
    ProtView    &= ~FILE_MAP_EXECUTE;
  }


  __try 
  {
    FileMapping =  
      CreateFileMapping(INVALID_HANDLE_VALUE,
									      NULL,
									      ProtMapping,
									      0,
									      Size,
									      L"");
    if(!FileMapping)
	    __leave;

    LinearMapping = 
      (ULONG_PTR)MapViewOfFileEx(FileMapping,
									             ProtView,
									             0,
									             0,
                               Size,
                               preferredAddress);
  }
  __finally
  {
    if(!LinearMapping)
    {
      if(FileMapping)
        CloseHandle(FileMapping);
    }
  }
  return LinearMapping;
}



PVOID CreateUspaceMapping(UINT blocks)
{
  return (PVOID)GetAnonymousMap(blocks, FALSE, NULL);
}

PVOID CreateUspaceExecMapping(UINT blocks)
{
  return (PVOID)GetAnonymousMap(blocks, TRUE, NULL);
}

PVOID CreateUspaceMappingWithAddr(UINT blocks, PVOID preferredAddress)
{
  return (PVOID)GetAnonymousMap(blocks, TRUE, preferredAddress);
}